var initialData_js=[{name:"Justin Vineyards & Winery",url:"http://justinwine.com",addr1:"11680 Chimney Rock Road ",addr2:"Paso Robles, CA",lat:"35.6549549",lng:"-120.90086100000002",infoAry:[{type:"Winery",infoText:"my winery info"}]},{name:"Ventuex Vineyards",url:"www.ventuexvineyards.com",addr1:"1795 Las Tablas Road",addr2:"Templeton, CA ",lat:"35.5557948",lng:"-120.73473939999997",infoAry:[{type:"Winery",infoText:"my winery info"}]},{name:"Opolo Vineyards",url:"www.opolo.com",addr1:"7110 Vineyard Drive",addr2:"Paso Robles, CA",lat:"35.5911107",lng:"-120.82076139999998",infoAry:[{type:"Winery",infoText:"winery info"}]},{name:"McPhee's Grill",url:"www.mcpheesgrill.com",addr1:"416 South Main Street",addr2:"Templeton, CA",lat:"35.549482",lng:"-120.70558699999998",infoAry:[{type:"Restaurant",infoText:"Excellent food. The prices are not low."}]},{name:"Thomas Hill Organics",url:"www.thomashillorganics.com",addr1:"1313 Park Street",addr2:"Paso Robles, CA",lat:"35.62799040000001",lng:"-120.69050370000002",infoAry:[{type:"Restaurant",infoText:"If you like places with organic food you should be very happy here. It's excellent."}]},{name:"AJ Spurs Saloon & Dining",url:"www.ajspurs.com",addr1:"508 South Main Street",addr2:"Templeton, CA",lat:"35.5488203",lng:"-120.70616949999999",infoAry:[{type:"Restaurant",infoText:"Ranch/western food. If you're suspicious of places with organic food you should be happy here."}]},{name:"Bike Lane Inn",url:"http://www.bedandbreakfast.com/ca-templeton-bike-lane-inn.html",addr1:"749 Gough Ave",addr2:"Templeton, CA",lat:"35.5495934",lng:"-120.71220779999999",infoAry:[{type:"Lodging",infoText:"A B&B with reasonable rates and good reviews (I've never stayed here)."}]},{name:"Carriage Vineyards B&B",url:"http://www.bedandbreakfast.com/california-templeton-carriagevineyardsbb.html",addr1:"4337 South El Pomar",addr2:"Templeton, CA",lat:"35.5280007",lng:"-120.6194855",infoAry:[{type:"Lodging",infoText:"A B&B with good reviews (I've never stayed here)"}]},{name:"Sculpterra Winery",url:"www.sculpterra.com",addr1:"5015 Linne Road",addr2:"Paso Robles, CA",lat:"35.6006138",lng:"-120.61066119999998",infoAry:[{type:"Winery",infoText:"Great sculpture garden"}]},{name:"Epoch Estate Wines",url:"www.epochwines.com",addr1:"7505 York Mountain Road",addr2:"Templeton, CA",lat:"35.5448834",lng:"-120.82751559999997",infoAry:[{type:"Winery",infoText:"Nice patio"}]},{name:"Niner Wine Estates",url:"www.ninerwine.com",addr1:"2400 Highway 46 West",addr2:"Paso Robles, CA",lat:"35.5705018",lng:"-120.74188509999999",infoAry:[{type:"Winery",infoText:"Have not visited"}]},{name:"Peachy Canyon Winery",url:"www.peachycanyon.com",addr1:"1480 North Bethel Road",addr2:"Templeton, CA",lat:"35.579805",lng:"-120.71890639999998",infoAry:[{type:"Winery",infoText:"Good Zin"}]},{name:"Castoro Cellars",url:"www.castorocellars.com",addr1:"1315 North Bethel Road",addr2:"Templeton, CA",lat:"35.5772607",lng:"-120.72292099999999",infoAry:[{type:"Winery",infoText:"popular venue"}]},{name:"Calcareous Vineyard",url:"www.calcareous.com",addr1:"3430 Peachy Canyon Road",addr2:"Paso Robles, CA",lat:"35.629444",lng:"-120.75043700000003",infoAry:[{type:"Winery",infoText:"Wood-fire pizza oven, tables and umbrellas"}]}];
function initialize(){var e=document.getElementById("map-canvas"),r={mapTypeId:google.maps.MapTypeId.ROADMAP};try{var o=new google.maps.Map(e,r);return o}catch(t){$("#error-msg").html(errorMsg.maps)}}var ko,console,google,locations=initialData_js,map,MAX_ZINDEX=google.maps.Marker.MAX_ZINDEX,flickrPhotoArray,foursquarePhotoArray,flickrIndex=0,foursquareIndex=0,selectedVenueIndex=-1,photoSrc="",enableMarkerLoad=!1,errorMsg={};errorMsg.FourSqfail="The data request to Foursquare failed. ",errorMsg.FourSqfail+="<br>Please check your internet connection.",errorMsg.Flickrfail="The data request to Flickr failed. ",errorMsg.Flickrfail+="<br>Please check your internet connection.",errorMsg.maps="The data requrest to google.maps failed.",errorMsg.maps+="<br>Please check your internet connection.";var errorString="",CLIENT_ID="5MLJLSYO3U3D1NXRVDTDLYYWXNHP0CEMUOEG1C2ECMD20VO2",CLIENT_SECRET="40QSTRMCYD4IOTESKJVF532Z015MMI2M35GUXO2K5UQBQDYH",placeTypes=["All"],markerPng={Winery:"markers/purple_MarkerW.png",Restaurant:"markers/orange_MarkerR.png",Lodging:"markers/blue_MarkerL.png"},markerSelectedPng={Winery:"markers/darkgreen_MarkerW.png",Restaurant:"markers/darkgreen_MarkerR.png",Lodging:"markers/darkgreen_MarkerL.png"},markers=[],sortNames=function(e){e.sort(function(e,r){return e.name>r.name?1:e.name<r.name?-1:0})};sortNames(locations);var computeShowArray=function(e,r){for(var o,t,n,a=e.length,s=0;a>s;s++){t=["All"],n=e[s].infoAry.length;for(var l=0;n>l;l++)o=e[s].infoAry[l].type,t.push(o),-1===r.indexOf(o)&&r.push(o);e[s].show=t,e[s].index=s,r.sort()}};computeShowArray(locations,placeTypes);var getLatLng=function(e){try{for(var r=e.length,o=0;r>o;o++)e[o].latLng=new google.maps.LatLng(e[o].lat,e[o].lng)}catch(t){$("#error-msg").html(errorMsg.maps)}};getLatLng(locations);var setBounds=function(){try{for(var e=markers.length,r=new google.maps.LatLngBounds,o=0;e>o;o++)r.extend(markers[o].getPosition());map.fitBounds(r)}catch(t){$("#error-msg").html(errorMsg.maps)}},getFlickrNext=function(e){e%=flickrPhotoArray.length;var r=flickrPhotoArray[e].id,o=flickrPhotoArray[e].secret,t=flickrPhotoArray[e].farm,n=flickrPhotoArray[e].server,a=flickrPhotoArray[e].owner,s="n";console.log("farm, server, id, secret",t,n,r,o);var l="https://farm"+t+".staticflickr.com/"+n+"/"+r+"_"+o+"_"+s+".jpg";console.log("photoStr = "+l);var c='Source: <a href="https://flickr.com">Flickr</a>';c+='  by: <a href="https://flickr.com/people/'+a+'/"> photographer</a>',$("#img-text1").html(c),$("#info-img").attr("src",l),$("#img-counter").html("Image "+(e+1)+" of "+flickrPhotoArray.length)},getFlickrPhoto=function(e){flickrIndex=0;var r=locations[e].lat,o=locations[e].lng,t=.003,n=[];n.push(parseFloat(o)-t),n.push(parseFloat(r)-t),n.push(parseFloat(o)+t),n.push(parseFloat(r)+t),console.log("bbox = ",n);var a=$.get("https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key=22fc9c37821f6a73591b5bc4ad048e35&lat="+r+"&lon="+o+"&min_upload_date=2012&accuracy=16&bbox="+n[0]+","+n[1]+","+n[2]+","+n[3]+"&media=photos&format=json&nojsoncallback=1",function(e){flickrPhotoArray=e.photos.photo,flickrIndex=0,flickrPhotoArray.length>0?(console.log("number of photos for venue = ",flickrPhotoArray.length),getFlickrNext(flickrIndex)):($("#info-img").attr("src","#"),$("#info-img").attr("alt","No venue photos on Flickr"),$("#img-counter").html("0 images"),console.log("no photos for this venue")),console.log("success")});a.done(function(){errorString="",console.log("second success")}),a.fail(function(){console.log("error"),errorString=errorMsg.Flickrfail}),a.always(function(){$("#error-msg").html(errorString),console.log("finished")})},get4sqNext=function(e){foursquareIndex%=foursquarePhotoArray.length;var r=foursquarePhotoArray[foursquareIndex].prefix,o="cap300",t=foursquarePhotoArray[foursquareIndex].suffix;console.log("prefix, photoSize, suffix",r,o,t);var n=r+o+t;console.log("photoStr = "+n);var a='Source: <a href="https://foursquare.com">Foursquare</a><br>';a+=e,$("#img-text1").html(a),$("#info-img").attr("src",n),$("#img-counter").html("Image "+(foursquareIndex+1)+" of "+foursquarePhotoArray.length)},get4sqVenueDetail=function(e,r,o){foursquarePhotoArray={};var t=o,n="",a=$.get("https://api.foursquare.com/v2/venues/"+t+"?client_id="+CLIENT_ID+"&client_secret="+CLIENT_SECRET+"&v=20140115&m=foursquare",function(e){if(console.log("data.response.venue.photos:",e.response.venue.photos),e.response.venue.photos.count>0){foursquarePhotoArray=e.response.venue.photos.groups[0].items,foursquareIndex=0;var r=e.response.venue.canonicalUrl;n='Venue on <a href="'+r+"?ref="+CLIENT_ID+'">Foursquare</a>',get4sqNext(n)}else foursquarePhotoArray={},$("#info-img").attr("src","#"),$("#info-img").attr("alt","No venue photos on FourSquare");errorString="",console.log("success")});a.done(function(){errorString="",console.log("second success")}),a.fail(function(){console.log("Venue detail error"),errorString=errorMsg.FourSqfail}),a.always(function(){$("#error-msg").html(errorString),console.log("finished")})},get4sqSearch=function(e){var r=locations[e].lat,o=locations[e].lng,t=locations[e].name;console.log("name:",t);var n=$.get("https://api.foursquare.com/v2/venues/search?ll="+r+","+o+"&client_id="+CLIENT_ID+"&client_secret="+CLIENT_SECRET+"&limit=1&v=20140115&query="+t+"&intent=match&m=foursquare",function(r){if(r.response.venues[0]){var o=r.response.venues[0].id,t=r.response.venues[0].name;console.log("index, name, id",e,t,o),get4sqVenueDetail(e,t,o)}else{var n='<br>This venue was not found at <a href="https://foursquare.com">Foursquare</a>';$("#img-text1"+e).html(n),$("#info-img").attr("src","#"),$("#info-img").attr("alt","No venue photos on FourSquare"),console.log("The venue was not found on get4sqSearch")}errorString="",console.log("success")});n.done(function(){errorString="",console.log("second success")}),n.fail(function(){console.log("search error"),errorString=errorMsg.FourSqfail}),n.always(function(){$("#error-msg").html(errorString),console.log("finished")})},toggleBounce=function(e){var r=markers[e];if(null!==r.getAnimation())r.setAnimation(null);else try{r.setAnimation(google.maps.Animation.BOUNCE),window.setTimeout(function(){toggleBounce(e)},2100)}catch(o){$("#error-msg").html(errorMsg.maps)}var t=MAX_ZINDEX+1;r.zIndex=t},photoSearch=function(e){if(e>=0)switch($("#info-img").attr("src","#"),$("#info-img").attr("alt",""),$("#img-counter").html("0 images"),$("#img-text1").html(""),photoSrc){case"foursquare":get4sqSearch(e);break;case"flickr":getFlickrPhoto(e);break;default:getFlickrPhoto(e)}else $("#info-img").attr("alt","No Venue selected"),$("#info-img").attr("src","#"),$("#img-counter").html("0 images"),$("#img-text1").html(""),$("#venue-info").html(""),$("#venue-info-text").html("")},setSelectedVenue=function(e){var r,o,t,n,a,s,l,c,i,u="Selected venue: ";if(foursquarePhotoArray={},flickrPhotoArray={},$("#info-img").attr("src","#"),selectedVenueIndex>=0&&enableMarkerLoad&&(l=markers[selectedVenueIndex],s=locations[selectedVenueIndex].infoAry[0].type,a=markerPng[s],l.setIcon(a),l.setZIndex(MAX_ZINDEX)),e>=0&&enableMarkerLoad){r=locations[e].name,selectedVenueIndex=e,l=markers[e],s=locations[e].infoAry[0].type,a=markerSelectedPng[s],l.setIcon(a);var g=MAX_ZINDEX+1;l.setZIndex(g),console.log("markerNew = ",a),o=locations[e].url,t=locations[e].addr1,n=locations[e].addr2,console.log("venueUrl",o),c=locations[e].infoAry[0].infoText}else r="none",o="",t="",n="",c="",a="",i='<img id="marker-ref" class="marker inline" src="'+markerPng.Winery+'" alt="marker icon"> Winery  ',i+='<img id="marker-ref" class="marker inline" + src="'+markerPng.Lodging+'" alt="marker icon"> Lodging  ',i+='<img id="marker-ref" class="marker inline" + src="'+markerPng.Restaurant+'" alt="marker icon"> Restaurant  ';if($("#selected-list-pg").html(u+r),$("#selected-photo-pg").html(u+r),$("#selected-info-pg").html(u+r),$("#selected-map-pg").html(""!==a?'<img id="marker-ref" class="marker inline" src="'+a+'" alt="marker icon"> '+r:i),e>=0&&enableMarkerLoad){var f="<a href="+o+">"+r+"</a><br>";f+=t+"<br>",f+=n+"<br>",console.log("contentStr = ",f),$("#venue-info").html(f),$("#venue-info-text").html(c)}photoSearch(e)},attachMarkerListener=function(e,r){google.maps.event.addListener(e,"click",function(){photoSearch(r),markers[r].setAnimation(null),setSelectedVenue(r),toggleBounce(r)})},setMarkers=function(e,r){for(var o=r.length,t=0;o>t;t++){var n=r[t].infoAry[0].type,a=markerPng[n];try{var s=new google.maps.Marker({position:r[t].latLng,map:e,title:r[t].name,visible:!0,icon:a});markers[t]=s,attachMarkerListener(s,t)}catch(l){$("#error-msg").html(errorMsg.maps)}}},MyViewModel=function(e){"use strict";var r=this;r.placeTypes=ko.observableArray(placeTypes),r.selectedPlaceType=ko.observableArray(["Winery"]),r.searchText=ko.observable(""),r.photoSource=ko.observable("flickr"),r.places=ko.observableArray(ko.utils.arrayMap(e,function(e){return{name:e.name,index:e.index,url:e.url,addr1:e.addr1,addr2:e.addr2,lat:e.lat,lng:e.lng,infoAry:ko.observableArray(e.infoAry),show:ko.observableArray(e.show)}})),r.includesSelectedType=function(e,o,t){return t.indexOf(e()[0])>=0&&(r.showMarker(o),-1!==r.places()[o].name.toLowerCase().indexOf(r.searchText().toLowerCase()))?!0:(r.hideMarker(o),setSelectedVenue(-1),!1)},r.searchForText=function(){console.log("self.searchText:",r.searchText());for(var e=r.places().length,o=0;e>o;o++)-1!==r.places()[o].show.indexOf(r.selectedPlaceType()[0])&&-1!==r.places()[o].name.indexOf(r.searchText())&&console.log("match: ",r.searchText())},r.showMarker=function(e){markers[e].setMap(map)},r.hideMarker=function(e){markers[e].setMap(null)},r.showInfo=function(e){enableMarkerLoad&&(setSelectedVenue(e),markers[e].setAnimation(null),toggleBounce(e))},r.setBounds=function(){setBounds()},r.setPhotoSource=function(){switch(photoSrc=r.photoSource(),console.log("photoSrc = ",photoSrc),photoSrc){case"foursquare":flickrPhotoArray={};break;case"flickr":foursquarePhotoArray={}}photoSearch(selectedVenueIndex)},r.previousPhoto=function(){if(selectedVenueIndex>=0){var e;switch(photoSrc){case"foursquare":e=foursquarePhotoArray.length,e>0&&(foursquareIndex=foursquareIndex>0?foursquareIndex-1:e-1,get4sqNext(foursquareIndex));break;case"flickr":e=flickrPhotoArray.length,e>0&&(flickrIndex=flickrIndex>0?flickrIndex-1:e-1,getFlickrNext(flickrIndex));break;default:getFlickrPhoto(selectedVenueIndex)}}else $("#info-img").attr("alt","No Venue selected")},r.nextPhoto=function(){if(selectedVenueIndex>=0)switch(photoSrc){case"foursquare":foursquarePhotoArray.length>0&&(foursquareIndex+=1,get4sqNext(foursquareIndex));break;case"flickr":flickrPhotoArray.length>0&&(flickrIndex+=1,getFlickrNext(flickrIndex));break;default:getFlickrPhoto(selectedVenueIndex)}else $("#info-img").attr("alt","No Venue selected")},r.clearSearch=function(){$("#search-text").val("").trigger("change"),setSelectedVenue(-1)}};$(document).ready(function(){map=initialize(),setMarkers(map,locations),setBounds(),ko.applyBindings(new MyViewModel(locations)),enableMarkerLoad=!0});