var initialData_js=[{name:"Justin Vineyards & Winery",url:"http://justinwine.com/",addr1:"11680 Chimney Rock Road ",addr2:"Paso Robles, CA",lat:"35.6549549",lng:"-120.90086100000002",infoAry:[{type:"Winery",infoText:"my winery info"},{type:"Food",infoText:"my food info"},{type:"Lodging",infoText:"my lodging info"}]},{name:"Ventuex Vineyards",url:"www.ventuexvineyards.com",addr1:"1795 Las Tablas Road",addr2:"Templeton, CA ",lat:"35.5557948",lng:"-120.73473939999997",infoAry:[{type:"Winery",infoText:"my winery info"},{type:"Food",infoText:"my food info"},{type:"Lodging",infoText:"B&B"}]},{name:"Opolo Vineyards",url:"www.opolo.com",addr1:"7110 Vineyard Drive",addr2:"Paso Robles, CA",lat:"35.5911107",lng:"-120.82076139999998",infoAry:[{type:"Winery",infoText:"winery info"},{type:"Food",infoText:"BBQ on weekends"}]},{name:"McPhee's Grill",url:"www.mcpheesgrill.com",addr1:"416 South Main Street",addr2:"Templeton, CA",lat:"35.549482",lng:"-120.70558699999998",infoAry:[{type:"Food",infoText:"Excellent food. The prices are not low."}]},{name:"Thomas Hill Organics",url:"www.thomashillorganics.com",addr1:"1313 Park Street",addr2:"Paso Robles, CA",lat:"35.62799040000001",lng:"-120.69050370000002",infoAry:[{type:"Food",infoText:'If you like places with "organic" in the name you should be very happy here. It\'s excellent.'}]},{name:"AJ Spurs Saloon & Dining",url:"www.ajspurs.com",addr1:"508 South Main Street",addr2:"Templeton, CA",lat:"35.5488203",lng:"-120.70616949999999",infoAry:[{type:"Food",infoText:"Ranch/western food. If you're suspicious of places with \"organic\" in the name, you'll probably be happier here.  "}]},{name:"Bike Lane Inn",url:"http://www.bedandbreakfast.com/ca-templeton-bike-lane-inn.html",addr1:"749 Gough Ave",addr2:"Templeton, CA",lat:"35.5495934",lng:"-120.71220779999999",infoAry:[{type:"Lodging",infoText:"A B&B with reasonable rates and good reviews (I've never stayed here)."}]},{name:"Carriage Vineyards B&B",url:"http://www.bedandbreakfast.com/california-templeton-carriagevineyardsbb.html",addr1:"4337 South El Pomar",addr2:"Templeton, CA",lat:"35.5280007",lng:"-120.6194855",infoAry:[{type:"Lodging",infoText:"A B&B with good reviews (I've never stayed here)"}]},{name:"Sculpterra Winery",url:"www.sculpterra.com",addr1:"5015 Linne Road",addr2:"Paso Robles, CA",lat:"35.6006138",lng:"-120.61066119999998",infoAry:[{type:"Winery",infoText:"Great sculpture garden"}]},{name:"Epoch Estate Wines",url:"www.epochwines.com",addr1:"7505 York Mountain Road",addr2:"Templeton, CA",lat:"35.5448834",lng:"-120.82751559999997",infoAry:[{type:"Winery",infoText:"Nice patio"}]},{name:"Niner Wine Estates",url:"www.ninerwine.com",addr1:"2400 Highway 46 West",addr2:"Paso Robles, CA",lat:"35.5705018",lng:"-120.74188509999999",infoAry:[{type:"Winery",infoText:"Have not visited"}]},{name:"Peachy Canyon Winery",url:"www.peachycanyon.com",addr1:"1480 North Bethel Road",addr2:"Templeton, CA",lat:"35.579805",lng:"-120.71890639999998",infoAry:[{type:"Winery",infoText:"Good Zin"}]},{name:"Castoro Cellars",url:"www.castorocellars.com",addr1:"1315 North Bethel Road",addr2:"Templeton, CA",lat:"35.5772607",lng:"-120.72292099999999",infoAry:[{type:"Winery",infoText:"popular venue"}]}];
function initialize(){var e=document.getElementById("map-canvas"),r={mapTypeId:google.maps.MapTypeId.ROADMAP};try{var o=new google.maps.Map(e,r);return o}catch(n){$("#error-msg").html(errorMsg.maps)}}var locations=initialData_js,map,show,enableMarkerLoad=!1,errorMsg={};errorMsg.fail="The data request to Foursquare failed. ",errorMsg.fail+="<br>Please check your internet connection.",errorMsg.maps="The data requrest to google.maps failed.",errorMsg.maps+="<br>Please check your internet connection.";var errorString="",CLIENT_ID="5MLJLSYO3U3D1NXRVDTDLYYWXNHP0CEMUOEG1C2ECMD20VO2",CLIENT_SECRET="40QSTRMCYD4IOTESKJVF532Z015MMI2M35GUXO2K5UQBQDYH",placeTypes=["All"],markers=[],infowindowArray=[],sortNames=function(e){e.sort(function(e,r){return e.name>r.name?1:e.name<r.name?-1:0})};sortNames(locations);var computeShowArray=function(e,r){for(var o,n=0;n<e.length;n++){show=["All"];for(var a=0;a<e[n].infoAry.length;a++)o=e[n].infoAry[a].type,show.push(o),-1===r.indexOf(o)&&r.push(o);e[n].show=show,e[n].index=n,r.sort()}};computeShowArray(locations,placeTypes);var computeContentString=function(e){for(var r=0;r<e.length;r++){var o="";o+="<p>",o+='<a href="'+e[r].url+'"> '+e[r].name+"</a>",o+="</p>",o+='<img id="info-img'+r+'" alt="Venue photo" title="" src="" />',o+='<p id="info-text'+r+'"></p>',e[r].infoWindowContent=o}};computeContentString(locations);var getLatLng=function(e){try{for(var r=0;r<e.length;r++)e[r].latLng=new google.maps.LatLng(e[r].lat,e[r].lng)}catch(o){$("#error-msg").html(errorMsg.maps)}};getLatLng(locations);var closeInfoWindows=function(){for(var e=0;e<markers.length;e++)infowindowArray[e].close(markers[e].get("map"),markers[e])},get4sqVenueDetail=function(e,r,o){var n=o,a=$.get("https://api.foursquare.com/v2/venues/"+n+"?client_id="+CLIENT_ID+"&client_secret="+CLIENT_SECRET+"&v=20140115&m=foursquare",function(o){var n=o.response.venue.canonicalUrl,a=""+o.response.venue.bestPhoto.prefix+"cap300"+o.response.venue.bestPhoto.suffix,t='<a href="'+n+"?ref="+CLIENT_ID+'">'+r+"</a>",s='<br>Photo provided by: <br><a href="https://foursquare.com">Foursquare</a>';$("#info-text"+e).html(t+s),$("#info-img"+e).attr("src",a),$("#info-img"+e).attr("title",r),errorString="",console.log("success")});a.done(function(){console.log("second success")}),a.fail(function(){console.log("Venue detail error"),errorString=errorMsg.fail}),a.always(function(){$("#error-msg").html(errorString),console.log("finished")})},get4sqSearch=function(e){var r=locations[e].lat,o=locations[e].lng,n=locations[e].name;console.log("name:",n);var a=$.get("https://api.foursquare.com/v2/venues/search?ll="+r+","+o+"&client_id="+CLIENT_ID+"&client_secret="+CLIENT_SECRET+"&limit=1&v=20140115&query="+n+"&intent=match&m=foursquare",function(r){if(r.response.venues[0]){var o=r.response.venues[0].id,n=r.response.venues[0].name;get4sqVenueDetail(e,n,o)}else{var a='<br>This venue was not found at <a href="https://foursquare.com">Foursquare</a>';$("#info-text"+e).html(a),$("#info-img"+e).attr("alt","Venue photo not available")}errorString="",console.log("success")});a.done(function(){console.log("second success")}),a.fail(function(){console.log("search error"),errorString=errorMsg.fail}),a.always(function(){$("#error-msg").html(errorString),console.log("finished")})},attachInfotext=function(e,r){try{var o=new google.maps.InfoWindow({content:locations[r].infoWindowContent,maxWidth:300});infowindowArray[r]=o,google.maps.event.addListener(e,"click",function(){closeInfoWindows(),$("#info-img").attr("src",""),infowindowArray[r].open(markers[r].get("map"),markers[r]),get4sqSearch(r)})}catch(n){$("#error-msg").html(errorMsg.maps)}},setMarkers=function(e,r){for(var o=0;o<r.length;o++)try{var n=new google.maps.Marker({position:r[o].latLng,map:e,title:r[o].name,visible:!0});markers[o]=n,attachInfotext(n,o)}catch(a){$("#error-msg").html(errorMsg.maps)}},toggleBounce=function(e){var r=markers[e];if(null!==r.getAnimation())r.setAnimation(null);else try{r.setAnimation(google.maps.Animation.BOUNCE),window.setTimeout(function(){toggleBounce(e)},2100)}catch(o){$("#error-msg").html(errorMsg.maps)}},MyViewModel=function(e){"use strict";var r=this;r.placeTypes=ko.observableArray(placeTypes),r.selectedPlaceType=ko.observableArray(["All"]),r.searchText=ko.observable(""),r.places=ko.observableArray(ko.utils.arrayMap(e,function(e){return{name:e.name,index:e.index,url:e.url,addr1:e.addr1,addr2:e.addr2,lat:e.lat,lng:e.lng,infoAry:ko.observableArray(e.infoAry),show:ko.observableArray(e.show),infoWindowContent:e.infoWindowContent}})),r.includesSelectedType=function(e,o,n){return n.indexOf(e()[0])>=0&&(r.showMarker(o),-1!==r.places()[o].name.toLowerCase().indexOf(r.searchText().toLowerCase()))?!0:(r.hideMarker(o),!1)},r.searchForText=function(){console.log("self.searchText:",r.searchText());for(var e=0;e<r.places().length;e++)-1!==r.places()[e].show.indexOf(r.selectedPlaceType()[0])&&-1!==r.places()[e].name.indexOf(r.searchText())&&console.log("match: ",r.searchText())},r.showMarker=function(e){markers[e].setMap(map)},r.hideMarker=function(e){markers[e].setMap(null);for(var r=0;r<markers.length;r++)infowindowArray[r].close(markers[r].get("map"),markers[r])},r.closeInfoWindows=function(){for(var e=0;e<markers.length;e++)infowindowArray[e].close(markers[e].get("map"),markers[e]),$("#info-img").attr("src","")},r.showInfoWindow=function(e){r.closeInfoWindows(),enableMarkerLoad&&(infowindowArray[e].open(markers[e].get("map"),markers[e]),markers[e].setAnimation(null),toggleBounce(e),get4sqSearch(e))}};$(document).ready(function(){map=initialize(),setMarkers(map,locations);try{for(var e=new google.maps.LatLngBounds,r=0;r<markers.length;r++)e.extend(markers[r].getPosition());map.fitBounds(e)}catch(o){$("#error-msg").html(errorMsg.maps)}ko.applyBindings(new MyViewModel(locations)),window.setTimeout(function(){enableMarkerLoad=!0},2e3)});